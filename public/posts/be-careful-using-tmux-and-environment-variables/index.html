<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Watch out for these common pitfalls when using tmux and environment variables and learn how to avoid them."><link rel=canonical href=https://aj.codes/posts/be-careful-using-tmux-and-environment-variables/><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@ajorgensen"><meta name=og:title content="Be Careful Using tmux and Environment Variables"><meta property="og:type" content="website"><meta property="og:description" content="Watch out for these common pitfalls when using tmux and environment variables and learn how to avoid them."><meta property="og:url" content="https://aj.codes/posts/be-careful-using-tmux-and-environment-variables/"><meta name=og:image content="/images/cat.jpg"><meta name=twitter:image content="/images/cat.jpg"><meta name=twitter:creator content="@ajorgensen"><meta name=twitter:title content="Be Careful Using tmux and Environment Variables"><title>Be Careful Using tmux and Environment Variables - Andrew Jorgensen</title><meta name=generator content="Hugo 0.95.0"><link rel=stylesheet type=text/css href=https://aj.codes/css/output.css><link rel=stylesheet type=text/css href=https://aj.codes/css/syntax.css><script src=https://aj.codes/js/theme-toggle.js></script>
<script src=https://aj.codes//js/feather.min.js></script></head><body class="flex flex-col md:mx-auto mx-8 min-h-screen max-w-prose font-sans text-gray-700 dark:text-white bg-light-background dark:bg-dark-background"><header class=py-8><div class="flex flex-row justify-between"><div><a class="text-xl font-semibold hover:text-accent" href=https://aj.codes/>Andrew Jorgensen</a></div><div><a class="justify-between text-lg hover:text-accent" href=/tags>Tags</a></div></div></header><main class=flex-1><article class="w-full prose max-w-prose dark:prose-invert lg:prose-xl"><h1><span>Be Careful Using tmux and Environment Variables</span><div class="text-xl mt-4"><time class="font-mono not-prose font-thin">2023-03-02</time>
⋅
<a class="text-accent text-xl m" href=/tags/tmux>tmux</a></div></h1><section class="leading-normal space-y-4"><p>tmux has an interesting quirk in the way it handles environment variables that if you&rsquo;re not careful can cause some seemingly strange behavior.</p><p>Fortunately, this behavior is documented but in my opinion, is not intuitive. From the tmux man page:</p><blockquote><p><strong class=text-accent>When the server is started, tmux copies the environment into the
global environment;</strong> in addition, each session has a session
environment. When a window is created, the session and global
environments are merged. If a variable exists in both, the value
from the session environment is used. The result is the initial
environment passed to the new process.</p></blockquote><p>What this says is that the global environment is copied over when the <strong>server</strong> is
started. Each session also has an environment that is merged with the original
global environment but it only has a set list of environment variables that are
updated. You can see this with the following command in a tmux session:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>&gt;</span> tmux show-environment
</span></span><span class=line><span class=cl><span class=go>-DISPLAY
</span></span></span><span class=line><span class=cl><span class=go>-KRB5CCNAME
</span></span></span><span class=line><span class=cl><span class=go>-SSH_AGENT_PID
</span></span></span><span class=line><span class=cl><span class=go>-SSH_ASKPASS
</span></span></span><span class=line><span class=cl><span class=go>SSH_AUTH_SOCK
</span></span></span><span class=line><span class=cl><span class=go>-SSH_CONNECTION
</span></span></span><span class=line><span class=cl><span class=go>-WINDOWID
</span></span></span><span class=line><span class=cl><span class=go>-XAUTHORITY
</span></span></span></code></pre></div><p>This can cause some interesting consequences when you have multiple named tmux sessions running. Here&rsquo;s an example of
this in action:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>&gt;</span> <span class=nb>export</span> <span class=nv>FOO</span><span class=o>=</span>foo
</span></span><span class=line><span class=cl><span class=gp>&gt;</span> tmux new-session -t first
</span></span><span class=line><span class=cl><span class=gp>&gt;</span> <span class=nb>echo</span> <span class=nv>$FOO</span>
</span></span><span class=line><span class=cl><span class=go>foo
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>&gt;</span> <span class=nb>export</span> <span class=nv>FOO</span><span class=o>=</span>bar
</span></span><span class=line><span class=cl><span class=gp>&gt;</span> tmux new-session -t second
</span></span><span class=line><span class=cl><span class=gp>&gt;</span> <span class=nb>echo</span> <span class=nv>$FOO</span>
</span></span><span class=line><span class=cl><span class=go>foo
</span></span></span></code></pre></div><p>As long as the tmux server is running, it will retain the copy of the environment at the moment it was started and
unless the environment variable is in a set list it will not be updated when a new session starts <strong>even</strong> if its a
completely separate session.</p><p>There are a few different ways to work around this. If you know you&rsquo;ll want a specific environment variable updated each
time you start a new session, you can add the variable to the global update list.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>tmux.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>set-option -g update-environment &#34;FOO&#34;
</span></span></code></pre></div><p>This will tell tmux the session environment for <code>$FOO</code> whenever a new session is created or an existing session is
attached to.</p><p>Alternatively, you can manually update the environment using <code>tmux set-environment</code> this can be applied to either the
global environment so that each new session picks up the new value or for a specific session.</p><p>Lastly, you can avoid the problem altogether by providing a named socket to tmux using <code>-L</code> which will cause a new server to start
and copy the current environment into the global environment.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>&gt;</span> <span class=nb>export</span> <span class=nv>FOO</span><span class=o>=</span>foo
</span></span><span class=line><span class=cl><span class=gp>&gt;</span> tmux new-session -t first
</span></span><span class=line><span class=cl><span class=gp>&gt;</span> <span class=nb>echo</span> <span class=nv>$FOO</span>
</span></span><span class=line><span class=cl><span class=go>foo
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=gp>&gt;</span> <span class=nb>export</span> <span class=nv>FOO</span><span class=o>=</span>bar
</span></span><span class=line><span class=cl><span class=gp>&gt;</span> tmux -L other new-session -t second
</span></span><span class=line><span class=cl><span class=gp>&gt;</span> <span class=nb>echo</span> <span class=nv>$FOO</span>
</span></span><span class=line><span class=cl><span class=go>bar
</span></span></span></code></pre></div><p>This does make the ergonomics for tmux a little more cumbersome since you&rsquo;ll need to provide the name of the socket
each time you want to run tmux commands. For example, to re-attach to the <code>second</code> session you&rsquo;ll need to do <code>tmux -L other attach -t second</code>.</p></section></article></main><footer class="flex flex-col mb-5"><div><hr class="my-8 h-px w-full bg-gray-700 border-0 dark:bg-gray-700"></div><div class="flex flex-row justify-evenly space-x-3 text-s divide-gray-400"><span><a class="text-accent text-sm" href=https://github.com/ajorgensen/ title=GitHub><i class="w-5 h-5" data-feather=github></i></a></span>
<span>|</span><span>
<a class="text-accent text-sm" href=https://twitter.com/ajorgensen/ title=Twitter><i class="w-5 h-5" data-feather=twitter></i></a></span>
<span>|</span><span>
<a class="text-accent text-sm" href=/index.xml title=RSS><i class="w-5 h-5" data-feather=rss></i></a></span>
<span>|</span><span>
2023 © Andrew Jorgensen</span>
<span>|</span>
<span>Built with <a class=hover:text-accent href=https://gohugo.io>Hugo</a></span>
<span>|</span>
<span id=theme-toggle class=hover:text-accent></span></div></footer><script data-goatcounter=https://ajorgensen.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<script>feather.replace()</script></body></html>